name: Deploy Agent to Vertex AI

on:
  workflow_dispatch:  # 👈 Manual trigger via GitHub UI

jobs:
  deploy-agent:
    runs-on: ubuntu-latest
    env:
      GOOGLE_PROJECT: geni-project
      REGION: asia-south1

    steps:
      - name: ⏬ Checkout Code
        uses: actions/checkout@v3

      - name: 🔐 Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 🛠 Install yq
        run: |
          sudo snap install yq

      - name: 📤 Convert YAML to JSON
        run: |
          yq -o=json '.' agent/hello_agent.yaml > agent/hello_agent.json

      - name: 🚀 Deploy Agent to Vertex AI (beta)
        run: |
          gcloud beta agent builder agents update \
            --agent=hello-agent \
            --agent-spec=agent/hello_agent.yaml \
            --project=${{ env.GOOGLE_PROJECT }} \
            --location=global \
            --quiet